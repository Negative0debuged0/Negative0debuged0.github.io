<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zer0's Chat</title>
  <style>
    /* Fullscreen Styling */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #a8e063, #56ab2f);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #fff;
      flex-direction: column;
    }

    /* Navbar Styling */
    .navbar {
      width: 100%;
      background-color: #333;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      padding: 10px 15px;
      transition: background 0.3s;
    }
    .navbar a:hover {
      background-color: #575757;
    }

    /* Chat Container Styling */
    .chat-container {
      background: rgba(0, 0, 0, 0.7);
      width: 80%;
      max-width: 900px;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 80px; /* Add space for the navbar */
      padding-top: 400px;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 28px;
    }

    /* Message Display Area */
    #messages {
      width: 100%;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      margin-bottom: 20px;
      color: #fff;
    }
    .message {
      padding: 10px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 6px;
      position: relative;
      text-align: left;
    }
    .timestamp {
      font-size: 0.8em;
      color: #ddd;
      position: absolute;
      right: 10px;
      top: 10px;
    }
    .reply-indicator {
      font-size: 0.9em;
      color: #c9f5d7;
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid #56ab2f;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    /* Reactions and Reply Styling */
    .reactions {
      cursor: pointer;
      margin-top: 8px;
    }
    .reactions span {
      margin-right: 10px;
    }
    .reaction-count {
      margin-left: 5px;
    }
    .reply {
      cursor: pointer;
      color: #4CAF50;
    }

    /* Input and Button Styling */
    textarea, input[type="text"], input[type="password"] {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #388E3C;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <a href="https://negative0debuged0.github.io">Home</a>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <h1>Zer0's chat (ask for help in the discord)</h1>

    <input type="text" id="nameInput" placeholder="Enter your name" required>
    <button id="setNameButton">Set Name</button>

    <div id="adminLogin">
      <input type="password" id="adminPassword" placeholder="Enter admin password">
      <button id="adminLoginButton">Login as Admin</button>
    </div>
  
    <div id="messages"></div>
    <textarea id="messageInput" placeholder="Type a message..." rows="4"></textarea><br>
    <button id="sendMessageButton">Send Message</button>
  </div>

  <script>
    const GIST_ID = '1197dbeb30bd90fd850f7176b0f5981f';  // Replace with your Gist ID
    const API_URL = `https://api.github.com/gists/${GIST_ID}`;

    // Fetch the GitHub token dynamically from environment variables injected by GitHub Actions
    const TOKEN = process.env.GITHUB_TOKEN || ''; // This will be injected during build

    const ADMIN_PASSWORD = "ExaTerra10100"; // Admin password

    let currentMessages = [];
    let userName = '';
    let isAdmin = false;
    let replyingToMessage = null;
    let lastFetchTime = ''; // For ETag-based conditional fetching

    function setName() {
      const nameInput = document.getElementById('nameInput');
      userName = nameInput.value.trim();
      if (userName) {
        nameInput.disabled = true;
        document.getElementById('setNameButton').disabled = true;
      }
    }

    function adminLogin() {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        alert("Admin access granted.");
      } else {
        alert("Incorrect password.");
      }
    }

    function fetchMessages() {
      fetch(API_URL, {
        headers: {
          'Authorization': `token ${TOKEN}`,
          'If-None-Match': lastFetchTime, // Check if the content has changed since last fetch
        }
      })
      .then(response => {
        if (response.status === 304) {
          return; // No content change
        } else if (response.status === 200) {
          lastFetchTime = response.headers.get('ETag'); // Update ETag if modified
          return response.json();
        } else {
          throw new Error('Failed to fetch messages');
        }
      })
      .then(data => {
        if (data) {
          const gistContent = data.files['chat.json'].content;
          try {
            currentMessages = JSON.parse(gistContent).messages || [];
            displayMessages(currentMessages);
          } catch (err) {
            console.error('Error parsing messages:', err);
          }
        }
      })
      .catch(err => {
        console.error('Error fetching messages:', err);
      });
    }

    function displayMessages(messages) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';
      messages.forEach((message, index) => {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        
        if (message.replyTo) {
          const replyDiv = document.createElement('div');
          replyDiv.classList.add('reply-indicator');
          replyDiv.innerHTML = `<strong>Reply to:</strong> ${message.replyTo.sender}: "${message.replyTo.text}"`;
          messageDiv.appendChild(replyDiv);
        }
        
        messageDiv.innerHTML += `
          <strong>${message.sender}</strong>: ${message.text}
          <div class="timestamp">${new Date(message.timestamp).toLocaleString()}</div>
          <div class="reactions">${renderReactions(message.reactions, index)}</div>
          <span class="reply" onclick="replyToMessage(${index})">Reply</span>
        `;
        
        messagesDiv.appendChild(messageDiv);
      });
    }

    function renderReactions(reactions, index) {
      const reactionTypes = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ˜¡'];
      return reactionTypes.map(type => {
        const count = reactions[type] || 0;
        return `
          <span onclick="addReaction(${index}, '${type}')">${type}</span>
          <span class="reaction-count">${count}</span>
        `;
      }).join(' ');
    }

    function addReaction(index, reaction) {
      const message = currentMessages[index];
      if (!message.reactions) message.reactions = {};
      message.reactions[reaction] = (message.reactions[reaction] || 0) + 1;
      updateGist();
    }

    function replyToMessage(index) {
      replyingToMessage = currentMessages[index];
      document.getElementById('messageInput').placeholder = `Replying to ${replyingToMessage.sender}: "${replyingToMessage.text}"`;
    }

    function updateGist() {
      const gistContent = JSON.stringify({ messages: currentMessages });
      fetch(API_URL, {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          files: {
            'chat.json': { content: gistContent }
          }
        })
      })
      .then(() => setTimeout(fetchMessages, 1000)) // Delay fetching to give GitHub time to process
      .catch(error => console.error('Error updating Gist:', error));
    }

    document.getElementById('setNameButton').addEventListener('click', setName);
    document.getElementById('adminLoginButton').addEventListener('click', adminLogin);
    document.getElementById('sendMessageButton').addEventListener('click', () => {
      const messageInput = document.getElementById('messageInput');
      const newMessage = {
        sender: userName,
        text: messageInput.value,
        reactions: {},
        replyTo: replyingToMessage ? { sender: replyingToMessage.sender, text: replyingToMessage.text } : null,
        timestamp: new Date().toISOString()
      };
      currentMessages.push(newMessage);
      updateGist();
      messageInput.value = '';
      messageInput.placeholder = 'Type a message...';
      replyingToMessage = null;
    });

    setInterval(fetchMessages, 1000); // Reduced interval for real-time updates
    fetchMessages(); // Initial load
  </script>
</body>
</html>
